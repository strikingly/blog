<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/blog/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>



  <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>



<link rel="stylesheet" type="text/css" href="/blog/css/main.css?v=0.4.4"/>
<!-- 
  <link href='http://fonts.useso.com/css?family=Source+Sans+Pro:400,400italic,700,700italic|Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
-->
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,700,700italic|Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>




  <meta name="keywords" content="active record,pattern,rails,ruby," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.4" />


<meta name="description" content="ContextMany times in my career, I had to face cases where I had to keep a history of one or many tables. Most of the time, the need of history comes after the main feature itself is developed and ends">
<meta property="og:type" content="article">
<meta property="og:title" content="Simple rails history pattern (ActiveRecord)">
<meta property="og:url" content="http://strikingly.github.io/blog/2015/09/14/Simple-rails-history-pattern-ActiveRecord/index.html">
<meta property="og:site_name" content="Tech Blog">
<meta property="og:description" content="ContextMany times in my career, I had to face cases where I had to keep a history of one or many tables. Most of the time, the need of history comes after the main feature itself is developed and ends">
<meta property="og:updated_time" content="2015-09-15T03:25:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Simple rails history pattern (ActiveRecord)">
<meta name="twitter:description" content="ContextMany times in my career, I had to face cases where I had to keep a history of one or many tables. Most of the time, the need of history comes after the main feature itself is developed and ends">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> Simple rails history pattern (ActiveRecord) | Tech Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-25124444-9', 'auto');
  ga('send', 'pageview');
</script>




  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/blog/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">
        <img class="svg-logo" src="/blog/images/strikingly-logo.svg">
        <span class="site-title-text"> Tech Blog </span>
      </span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="http://www.strikingly.com/s/careers/?utm_source=tech_blog" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-strikingly">
          <a href="https://www.strikingly.com/?utm_source=tech_blog" rel="section">
            <i class="menu-item-icon icon-next-strikingly"></i> <br />
            Strikingly
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              Simple rails history pattern (ActiveRecord)
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on
          <time itemprop="dateCreated" datetime="2015-09-14T10:42:19+08:00" content="2015-09-14">
            2015-09-14
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; &bullet; &nbsp; In
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/blog/categories/Backend/" itemprop="url" rel="index">
                  <span itemprop="name">Backend</span>
                </a>
              </span>

              
              
                , 
              

            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/blog/categories/Backend/English/" itemprop="url" rel="index">
                  <span itemprop="name">English</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; &bullet; &nbsp;
            <a href="/blog/2015/09/14/Simple-rails-history-pattern-ActiveRecord/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/09/14/Simple-rails-history-pattern-ActiveRecord/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h2 id="Context">Context</h2><p>Many times in my career, I had to face cases where I had to keep a history of one or many tables. Most of the time, the need of history comes after the main feature itself is developed and ends up in this kind of architecture:</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">|<span class="string"> Post         </span>|<span class="string">   </span>|<span class="string"> PostHistory   </span>|</span><br><span class="line">|<span class="string">==============</span>|<span class="string">   </span>|<span class="string">===============</span>|</span><br><span class="line">|<span class="string"> author_id    </span>|<span class="string">   </span>|<span class="string"> post_id       </span>|</span><br><span class="line">|<span class="string"> title        </span>|<span class="string">   </span>|<span class="string"> title         </span>|</span><br><span class="line">|<span class="string"> content      </span>|<span class="string">   </span>|<span class="string"> content       </span>|</span><br><span class="line">|<span class="string"> published    </span>|<span class="string">   </span>|<span class="string">---------------</span>|</span><br><span class="line">|<span class="string"> published_at </span>|</span><br><span class="line">|<span class="string">--------------</span>|</span><br></pre></td></tr></table></figure>
<p>It comes as the most natural and painless way to add the history feature to an existing entity. You can also find gems doing this job for you, in which case, they will serialize your Post in a generic history table.</p>
<p>Both of those approaches sound sexy because they’re simple to implement and they don’t introduce a “risk” for the Post model. Problem is, they’re very hard to maintain.</p>
<a id="more"></a>
<p>In the first case, every time we run a migration on the post table, we will have to run it on the PostHistory too. Double the work. If you have special columns (enum, serialized stuff in any manner), you also have to maintain the same code in both classes. Or you have to extract everything in modules to share it between classes, which makes the code less readable. If you use services, it can lead to even more complicated situations.</p>
<p>In the second case, if your Post model changes, restoring the serialized version from history will become hard, if not impossible. If you want to historize only a subset of properties from Post, it’s also inconvenient. Plus, if you have serialized columns in Post table, you will end with serialized data IN serialized data in the history table. Something you don’t want to deal with in case of bugs.</p>
<p>The other main problem is if you need to use history in another context than just reading values and showing them to a human, you will have a schizophrenic code, using sometimes Post, sometimes PostHistory.</p>
<p>This architecture also come with the classic problem “when do we create a new entry?”:</p>
<ul>
<li>before saving will imply that the last version is not in history, force you to read from 2 tables to have the complete history</li>
<li>after saving will imply that the last version is in two different places (content duplicated)</li>
</ul>
<p>Let’s take a simple example, restore values from history:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># services/posts/historize_service.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HistorizeService</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> </span>run(post)</span><br><span class="line">    history = <span class="constant">PostHistory</span>.create!(</span><br><span class="line">      <span class="symbol">title:</span> post.title,</span><br><span class="line">      <span class="symbol">content:</span> post.content</span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># services/posts/restore_from_history_service.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestoreFromHistoryService</span></span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:historize_service</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> </span>initialize(<span class="symbol">historize_service:</span>)</span><br><span class="line">    <span class="variable">@historize_service</span> = historize_service</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> </span>run(post, post_history)</span><br><span class="line">    <span class="constant">Post</span>.transaction <span class="keyword">do</span></span><br><span class="line">      historize_service.run(post)</span><br><span class="line">      post.title = post_history.title</span><br><span class="line">      post.content = post_history.content</span><br><span class="line">      <span class="comment"># this list can be very long</span></span><br><span class="line">      post.save!</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Also consider that in this specific case, published state is ambiguous. And if many versions in the history have different meanings, it’s hard to identify which one has what meaning. We could transfer “publish” informations into the history table but that would mean history would carry contextual informations and we would have to maintain the whole history to ensure only one version is published at a time. </p>
<h2 id="Separate_“meta”_and_“content”">Separate “meta” and “content”</h2><p>A more flexible solution you can consider is to separate in two separate models what is content (ie: what we need to keep track of over time) and what’s immutable over time.</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">|<span class="string"> Post                 </span>|<span class="string">   </span>|<span class="string"> Post::Content </span>|</span><br><span class="line">|<span class="string">======================</span>|<span class="string">   </span>|<span class="string">=============</span>|</span><br><span class="line">|<span class="string"> author_id            </span>|<span class="string">   </span>|<span class="string"> post_id     </span>|</span><br><span class="line">|<span class="string"> current_content_id   </span>|<span class="string">   </span>|<span class="string"> title       </span>|</span><br><span class="line">|<span class="string"> published_content_id </span>|<span class="string">   </span>|<span class="string"> content     </span>|</span><br><span class="line">|<span class="string"> last_published_at    </span>|<span class="string">   </span>|<span class="string"> created_at  </span>|</span><br><span class="line">|<span class="string">----------------------</span>|<span class="string">   </span>|<span class="string">-------------</span>|</span><br></pre></td></tr></table></figure>
<p>Using this design, whatever version you use, you will always manipulate the same type of object. You don’t have to double the logic and migrations. You keep your data stable over time. </p>
<p>To give specific meaning to specific versions, we will rely on foreign keys. Post::Content should not know it’s role in outside models. Let’s keep it as small as possible and focus on data.</p>
<p>Your post model will look like this:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># models/post.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span></span><br><span class="line">  <span class="comment"># Associations</span></span><br><span class="line">  has_many <span class="symbol">:contents</span></span><br><span class="line">  </span><br><span class="line">  has_one <span class="symbol">:current_content</span>, <span class="symbol">class_name:</span> <span class="string">'Post::Content'</span></span><br><span class="line">  has_one <span class="symbol">:published_content</span>, <span class="symbol">class_name:</span> <span class="string">'Post::Content'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Methods</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> </span>published?</span><br><span class="line">    published_content_id?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Create a new entry in history is as simple as that:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># services/posts/historize_service.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HistorizeService</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> </span>run(post)</span><br><span class="line">    <span class="constant">Post</span>.transaction <span class="keyword">do</span></span><br><span class="line">      new_content = post.current_content.dup</span><br><span class="line">      new_content.save!</span><br><span class="line">      post.update_attributes!(<span class="symbol">current_content:</span> new_content)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Compare to the previous version, we don’t need to modify this service every time we add (or remove) a property. It’s stable over time, that’s all we want.</p>
<p>The simplest way to deal with versions is to consider our Post::Content objects as immutable</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># services/posts/content/update_service.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateService</span></span></span><br><span class="line">  <span class="comment"># params</span></span><br><span class="line">  <span class="comment"># </span></span><br><span class="line">  <span class="comment"># * post: an instance of Post</span></span><br><span class="line">  <span class="comment"># * properties: a hash containing the following keys</span></span><br><span class="line">  <span class="comment">#   * title: (string) optional</span></span><br><span class="line">  <span class="comment">#   * content: (string) optional</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> </span>run(post, properties)</span><br><span class="line">    new_content = post.current_content.dup</span><br><span class="line">    new_content.attributes = properties</span><br><span class="line">    new_content.save!</span><br><span class="line">    post.update_attributes!(<span class="symbol">current_content:</span> new_content)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>This service will create a new content entry every time you want to update content properties (title and/or content). If you want to prevent blank entries that would create useless history entry, you can use a form object to validate the data before calling the service.</p>
<p>Let’s keep going with restoring an entry</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># services/posts/restore_content_from_history_service.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestoreContentFromHistoryService</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> </span>run(post, content)</span><br><span class="line">    <span class="constant">Post</span>.transaction <span class="keyword">do</span></span><br><span class="line">      <span class="comment"># in order to keep the structure coherent, we need to</span></span><br><span class="line">      <span class="comment"># create a new entry instead of linking the old one.</span></span><br><span class="line">      new_content = content.dup</span><br><span class="line">      new_content.save!</span><br><span class="line">      post.update_attributes!(<span class="symbol">current_version:</span> new_content)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Let’s see how we do the publishing now</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># services/posts/publish_service.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishService</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> </span>run(post)</span><br><span class="line">    post.update_attributes!(</span><br><span class="line">      <span class="symbol">published_content:</span> post.current_content,</span><br><span class="line">      <span class="symbol">last_published_at:</span> <span class="constant">Time</span>.now</span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>And voila! This design is flexible enough to add many features that won’t compromise the structure.</p>
<h2 id="Making_it_a_bit_more_transparent">Making it a bit more transparent</h2><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># models/post.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span></span><br><span class="line">  <span class="comment"># Delegations</span></span><br><span class="line">  delegate <span class="symbol">:title</span>, <span class="symbol">:content</span>, <span class="symbol">to:</span> <span class="symbol">:current_content</span>, <span class="symbol">allow_nil:</span> <span class="keyword">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># allow you to access directly post.title</span></span><br><span class="line"><span class="comment"># and masking the complexity of post.current_content.title</span></span><br><span class="line"><span class="comment"># (see demeter law https://en.wikipedia.org/wiki/Law_of_Demeter)</span></span><br></pre></td></tr></table></figure>
<h2 id="Plugging_features">Plugging features</h2><p>Adding version numbers, for example</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># models/posts/content.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post::Content</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span></span><br><span class="line">  <span class="comment"># Callbacks</span></span><br><span class="line">  before_create <span class="symbol">:tag_version_number</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Methods</span></span><br><span class="line">  </span><br><span class="line">  private</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> </span>tag_version_number</span><br><span class="line">    <span class="keyword">self</span>.version = generate_version_number</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> </span>generate_version_number</span><br><span class="line">    <span class="comment"># optimistic solution</span></span><br><span class="line">    (<span class="keyword">self</span>.<span class="keyword">class</span>.where(<span class="symbol">post_id:</span> post_id)</span><br><span class="line">               .maximum(<span class="symbol">:version</span>) || <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>This could also be extracted to a module, exposed as a method like</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="tag">has_versions_number</span> <span class="rule"><span class="attribute">scope</span>:<span class="value"> :post_id</span></span></span><br></pre></td></tr></table></figure>
<p>You can even disable update at model level to ensure no one is changing the history</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># lib/active_record/immutable_model.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActiveRecord</span></span></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">ImmutableModel</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">UpdateImmutableModelException</span> <span class="inheritance">&lt; <span class="parent">Exception</span></span></span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> </span>initialize(msg)</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"Immutable model can't be updated"</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    extend <span class="constant">ActiveSupport::Concern</span></span><br><span class="line">    </span><br><span class="line">    included <span class="keyword">do</span></span><br><span class="line">      before_update <span class="symbol">:prevent_update</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    private</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> </span>prevent_update</span><br><span class="line">      raise <span class="constant">UpdateImmutableModelException</span>.new</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>        </span><br><span class="line"></span><br><span class="line"><span class="comment"># models/post/content.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post::Content</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Base</span></span></span></span><br><span class="line">  <span class="keyword">include</span> <span class="constant">ActiveRecord::ImmutableModel</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="Recommendations">Recommendations</h2><p>To update Post  from forms, I discourage you to use ActiveRecord nested_attributes pattern as long as it’s a very horrible pattern (even if it looks very convenient). Instead, you would prefer to use a form object and hide the complexity of content versioning from your user.</p>
<h2 id="Conclusion">Conclusion</h2><p>This solution solves some problem cases but still have cons, like any other one. It has a higher cost at beginning but offers more flexibility over time, especially if you want to add features based on your history. It also allows you to easily “tag” and access some versions.</p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/blog/tags/active-record/" rel="tag">#active record</a>
          
            <a href="/blog/tags/pattern/" rel="tag">#pattern</a>
          
            <a href="/blog/tags/rails/" rel="tag">#rails</a>
          
            <a href="/blog/tags/ruby/" rel="tag">#ruby</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2015/09/07/css3-shadows/" rel="next">CSS3 Shadows Are Crazy Awesome</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
              </div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table Of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <p class="site-author-name" itemprop="name">Strikingly</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">categories</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">tags</span>
              
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/strikingly" target="_blank">github</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/strikingly" target="_blank">twitter</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/strikingly" target="_blank">facebook</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Context"><span class="nav-number">1.</span> <span class="nav-text">Context</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Separate_“meta”_and_“content”"><span class="nav-number">2.</span> <span class="nav-text">Separate “meta” and “content”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Making_it_a_bit_more_transparent"><span class="nav-number">3.</span> <span class="nav-text">Making it a bit more transparent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Plugging_features"><span class="nav-number">4.</span> <span class="nav-text">Plugging features</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Recommendations"><span class="nav-number">5.</span> <span class="nav-text">Recommendations</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">6.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Strikingly</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/blog/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'strikinglytech';
      var disqus_identifier = '2015/09/14/Simple-rails-history-pattern-ActiveRecord/';
      var disqus_title = 'Simple rails history pattern (ActiveRecord)';
      var disqus_url = 'http://strikingly.github.io/blog/2015/09/14/Simple-rails-history-pattern-ActiveRecord/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  


  
  
  <script type="text/javascript" src="/blog/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/blog/js/fancy-box.js?v=0.4.4"></script>


  <script type="text/javascript" src="/blog/js/helpers.js?v=0.4.4"></script>
  

  <script type="text/javascript" src="/blog/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/blog/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/blog/js/motion_global.js?v=0.4.4" id="motion.global"></script>




  <script type="text/javascript" src="/blog/js/nav-toggle.js?v=0.4.4"></script>
  <script type="text/javascript" src="/blog/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/blog/js/bootstrap.scrollspy.js?v=0.4.4" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/blog/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/blog/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
